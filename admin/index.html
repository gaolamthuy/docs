<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gạo Lâm Thúy - Content Manager</title>
    <meta name="description" content="Quản lý assets (hình ảnh, icons, logos) cho Gạo Lâm Thúy" />
    <!-- Decap CMS không cần Netlify Identity Widget khi dùng Cloudflare Pages -->
    <!-- GitHub OAuth sẽ được xử lý bởi Cloudflare Pages Functions -->
  </head>
  <body>
    <!-- Script xử lý OAuth token từ URL hash hoặc postMessage -->
    <script>
      (function() {
        // Xử lý token từ URL hash (khi redirect về)
        if (window.location.hash) {
          const hashParams = new URLSearchParams(window.location.hash.substring(1));
          const token = hashParams.get('token');
          const provider = hashParams.get('provider');
          
          if (token && provider === 'github') {
            // Lưu token vào localStorage cho Decap CMS
            // Thử cả hai key để đảm bảo tương thích
            const userData = {
              token: token,
              provider: provider,
              name: 'GitHub User',
              login: 'github-user'
            };
            
            try {
              localStorage.setItem('netlify-cms-user', JSON.stringify(userData));
              localStorage.setItem('decap-cms-user', JSON.stringify(userData));
            } catch(e) {
              console.error('Could not save token to localStorage:', e);
            }
            
            // Xóa token khỏi URL hash để bảo mật
            window.history.replaceState(null, '', window.location.pathname + window.location.search);
            
            // Reload page để Decap CMS nhận token
            window.location.reload();
            return;
          }
        }
        
        // Lắng nghe postMessage từ popup OAuth
        // Decap CMS sử dụng format: authorization:github:success:${JSON.stringify(content)}
        window.addEventListener('message', function(event) {
          // Chỉ nhận message từ cùng origin
          if (event.origin !== window.location.origin) {
            console.log('Message from different origin, ignoring:', event.origin);
            return;
          }
          
          console.log('Received message:', event.data);
          
          // Xử lý format Decap CMS: authorization:github:success:${JSON.stringify(content)}
          if (typeof event.data === 'string' && event.data.includes('authorization:github:success:')) {
            try {
              const contentStr = event.data.split('authorization:github:success:')[1];
              const content = JSON.parse(contentStr);
              const { token, provider } = content;
              
              if (token && provider === 'github') {
                console.log('Token received from popup, saving to localStorage');
                
                // Lưu token vào localStorage
                const userData = {
                  token: token,
                  provider: provider,
                  name: 'GitHub User',
                  login: 'github-user'
                };
                
                try {
                  localStorage.setItem('netlify-cms-user', JSON.stringify(userData));
                  localStorage.setItem('decap-cms-user', JSON.stringify(userData));
                  console.log('Token saved to localStorage');
                } catch(e) {
                  console.error('Could not save token to localStorage:', e);
                }
                
                // Reload page để Decap CMS nhận token
                console.log('Reloading page...');
                window.location.reload();
              }
            } catch(e) {
              console.error('Error parsing message:', e);
            }
          }
          
          // Fallback: Xử lý format object (nếu có)
          if (event.data && typeof event.data === 'object' && event.data.type === 'authorization') {
            const { token, provider } = event.data;
            
            if (token && provider === 'github') {
              console.log('Token received (object format), saving to localStorage');
              
              const userData = {
                token: token,
                provider: provider,
                name: 'GitHub User',
                login: 'github-user'
              };
              
              try {
                localStorage.setItem('netlify-cms-user', JSON.stringify(userData));
                localStorage.setItem('decap-cms-user', JSON.stringify(userData));
                console.log('Token saved to localStorage');
              } catch(e) {
                console.error('Could not save token to localStorage:', e);
              }
              
              // Reload page để Decap CMS nhận token
              console.log('Reloading page...');
              window.location.reload();
            }
          }
        });
      })();
    </script>
    
    <!-- Decap CMS Script -->
    <!-- Sử dụng CDN từ unpkg với version mới nhất -->
    <script src="https://unpkg.com/decap-cms@^3.0.0/dist/decap-cms.js"></script>
    
    <!-- 
      Decap CMS sẽ tự động load file config.yml từ cùng thư mục
      File config.yml phải được đặt tại: admin/config.yml
    -->
  </body>
</html>

